{% import "lists_macro.html" as macros %}
<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Личный кабинет</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/css/normalize.css')}}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/css/style.css')}}" />
  <link rel="icon" href="{{url_for('static', filename='styles/img/Logo.svg')}}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montaga&display=swap" rel="stylesheet">
  <link charset="utf-8" rel="stylesheet" href="{{url_for('static', filename='styles/css/smoke-pure.css')}}" />
  <script src="{{ url_for('static', filename='js/personal/add_book_js.js')}}"></script>
  <script src="{{ url_for('static', filename='js/personal/add_book_list_js.js')}}"></script>
  <script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
  <script src="{{ url_for('static', filename='js/personal/pagination.js')}}"></script> 
  <script src="{{ url_for('static', filename='js/page_scroll.js')}}"></script> 
  <style>
    * {
      box-sizing: border-box;
    }
    .openBtn {
      display: flex;
      justify-content: left;
    }
    .openButton {
      border: none;
      border-radius: 5px;
      background-color: #1c87c9;
      color: white;
      padding: 14px 20px;
      cursor: pointer;
      position: fixed;
    }
    .loginPopup {
      position: absolute;
      text-align: center;
      width: 100%;
    }
    .formPopup {
      position: fixed;
      left: 45%;
      top: 5%;
      transform: translate(-50%, 5%);
      border: 3px solid #999999;
      z-index: 9;
    }
    .formContainer {
      max-width: 300px;
      padding: 20px;
      background-color: #fff;
    }
    .formContainer input[type=text],
    .formContainer input[type=password] {
      width: 100%;
      padding: 15px;
      margin: 5px 0 20px 0;
      border: none;
      background: #eee;
    }
    .formContainer input[type=text]:focus,
    .formContainer input[type=password]:focus {
      background-color: #ddd;
      outline: none;
    }
    .formContainer .btn {
      padding: 12px 20px;
      border: none;
      background-color: #8ebf42;
      color: #fff;
      cursor: pointer;
      width: 100%;
      margin-bottom: 15px;
      opacity: 0.8;
    }
    .formContainer .cancel {
      background-color: #cc0000;
    }
    .formContainer .btn:hover,
    .openButton:hover {
      opacity: 1;
    }
  </style>
</head>

<body class="image-3" onload="book_added();">
  <header class="header style-1">
    <div class="header__container container">
      <a class="header__logo" href="{{url_for('main.index')}}">
        <img class="header__logo-image" src="{{url_for('static', filename='styles/img/logo.png')}}" alt="Логотип MAGIC BOOK KEEPER">
      </a>

      <nav class="nav header__nav">
        <ul class="nav__list list-reset">
          <li class="nav__item"><a class="nav__link" href="#">Меню
              <svg class="nav__fa" width="62" height="37" viewBox="0 0 62 37" fill="none"
                xmlns="http://www.w3.org/2000/svg">
                <line x1="8" y1="4.5" x2="53" y2="4.5" stroke="#E9E6C3" />
                <line x1="8" y1="31.5" x2="53" y2="31.5" stroke="#E9E6C3" />
                <line x1="8" y1="18.5" x2="53" y2="18.5" stroke="#E9E6C3" />
              </svg>

            </a>
            <ul class="nav__sublist list-reset">
              <li class="nav__subitem"><a class="nav__link" href="{{url_for('main.index')}}">Главная</a></li>
              <li class="nav__subitem"><a class="nav__link" href="{{url_for('main.categories')}}">Категории книг</a></li>
              {% if current_user.role == Role.ADMIN %}
                <li class="nav__subitem"><a class="nav__link" href="{{url_for('admin.admin_panel', username=current_user.username)}}">Административная панель</a></li> 
              {% endif %}
              <li class="nav__subitem"><a class="nav__link" href="{{url_for('auth.logout')}}">Выйти</a></li>
            </ul>
          </li>
        </ul>
      </nav>
    </div>
  </header>

  <main>
    <section class="main style-1">
      <div class="main__container container">

        <div class="main__top">
          <!-- <span class="main__span">Welcome!</span> -->
          <h1 class="main__title">Hello, {{ current_user.username }}!</h1>
          <!--Hello, имя пользователя!-->

          <svg width="461" height="1" viewBox="0 0 461 1" fill="none" xmlns="http://www.w3.org/2000/svg">
            <line y1="0.5" x2="461" y2="0.5" stroke="#E9E6C3" />
          </svg>

        </div>

        <div class="main__bottom">
          <a class="main__bottom-item" href="#1">Мой профиль</a>
          <!-- <a class="main__bottom-item" href="#">Моя статистика</a> -->
          <a class="main__bottom-item" href="#3">Мои списки книг</a>
        </div>
        <a class="main__btn btn" href="{{url_for('personal.add_new_book', username=current_user.username)}}">Добавить
          новую книгу</a>
      </div>
    </section>

    <div class="background-book_page" id="user_page_main_container">
      <section id="1" class="profile">
        <div class="profile__container container">
          <div class="profile__image">
            <img class="profile__image-set" src="{{url_for('personal.avatar', username=current_user.username)}}">
            <!--Тут добавленная фотка пользователем-->
          </div>
          <!-- <span class="profile__span">Фото профиля</span> -->
  
          <div class="profile__info">
            <span class="profile__span">Город: </span>
            <!--Тут информация введенная пользователем в редактировании профиля-->
            {% if user.city %}{{ user.city }}{% endif %}
          </div>
  
          <div class="profile__info">
            <span class="profile__span">Пол: </span>
            <!--Тут информация введенная пользователем в редактировании профиля-->
            {% if user.gender %}{{ user.gender }}{% endif %}
          </div>
  
          <div class="profile__info">
            <span class="profile__span">Возраст: </span>
            <!--Тут информация введенная пользователем в редактировании профиля-->
            {% if user.age %}{{ user.age }}{% endif %}
          </div>
  
          <div class="profile__info textarea">
            <span class="profile__span">О себе: </span>
            <!--Тут информация введенная пользователем в редактировании профиля-->
            {% if user.about_me %}{{ user.about_me }}{% endif %}
          </div>
  
          <!--<button class="profile__edit-btn" formaction="{{url_for('personal.edit', username=current_user.username)}}">Редактировать профиль</button>-->
          {% if user == current_user %}
          <a class="profile__edit-btn" href="{{url_for('personal.edit', username=current_user.username)}}">Редактировать
            профиль</a>
          {% endif %}
          <svg width="461" height="1" viewBox="0 0 461 1" fill="none" xmlns="http://www.w3.org/2000/svg">
            <line y1="0.5" x2="461" y2="0.5" stroke="black" />
          </svg>
  
          <!--<a class="profile__exit" href="{{url_for('auth.logout')}}">Выйти</a>-->
          <!--Выход из аккаунта-->
        </div>
      </section>
    

      <!-- Добавление списка -->
      {% if pagination %}
      <section class="loginPopup" id="popupForm" style="display: {{ display }}">
        <div class="formPopup">
          <form class="formContainer" action="{{url_for('personal.add_list', username=current_user.username, page=pagination.page)}}" method="post">
            {{form.hidden_tag()}}
            <label class="form__label">
              {% if form.list_name.errors %}
              <!--<input type="text" name="list_name" class="form__input" placeholder="Введите название списка..">-->
              {{form.list_name(class="form__input", placeholder="Введите название списка..")}}
              <span>
                {% for msg in form.list_name.errors %}
                {{ msg }}
                {% endfor %}
              </span>
              {% else %}
              {{form.list_name(class="form__input", placeholder="Введите название списка..")}}
              {% endif %}
            </label>
            <button class="comments__btn btn" id="add_list">Добавить</button>
            <button type="button" class="btn cancel" onclick="closeForm()">Отменить</button>
          </form>
        </div>
      </section>
      {% else %}
      <section class="loginPopup" id="popupForm" style="display: {{ display }}">
        <div class="formPopup">
          <form class="formContainer" action="{{url_for('personal.add_list', username=current_user.username, page=1)}}" method="post">
            {{form.hidden_tag()}}
            <label class="form__label">
              {% if form.list_name.errors %}
            
              {{form.list_name(class="form__input", placeholder="Введите название списка..")}}
              <span>
                {% for msg in form.list_name.errors %}
                {{ msg }}
                {% endfor %}
              </span>
              {% else %}
              {{form.list_name(class="form__input", placeholder="Введите название списка..")}}
              {% endif %}
            </label>
            <button class="comments__btn btn" id="add_list">Добавить</button>
            <button type="button" class="btn cancel" onclick="closeForm()">Отменить</button>
          </form>
        </div>
      </section>
      {% endif %}
      <script>scroll('add_list')</script>

      <!--Кнопка все время присутствует на странице пользователя-->
      <section class="list">
        <div id="3" class="container lists__create">
          <button class="lists__btn" onclick="openForm()">Создать список
          <svg width="78" height="78" viewBox="0 0 78 78" fill="none" xmlns="http://www.w3.org/2000/svg">
            <g clip-path="url(#clip0_139_2)">
              <rect x="35" width="8" height="78" fill="#D9D9D9" />
              <rect x="78" y="35" width="8" height="78" transform="rotate(90 78 35)" fill="#D9D9D9" />
            </g>
            <defs>
              <clipPath id="clip0_139_2">
                <rect width="78" height="78" fill="white" />
              </clipPath>
            </defs>
          </svg>
          </button>
        </div>
      </section>
      
        <!--место для списков-->
        {% for cataloge_value, pagination_for_book_in_list in zip(catalogues, paginations_for_books_in_lists) %}
        <section class="list" id="{{cataloge_value.id}}cataloge_info">
          <div class="container list__container">
            <div class="list__wrap">
              <h2 class="list__title title">{{ cataloge_value.name }}</h2>
              <!--Название списка, которое ввел пользователь-->
  
              <ul class="list__books list-reset" id="{{cataloge_value.id}}books_info_container">
                <!--Добавление книги в список - перебрасывает в рааздел категорий книг-->
                <li class="list__book list__add"><a href="{{url_for('main.categories', list_id=cataloge_value.id)}}" class="list__link">
                    <svg width="78" height="78" viewBox="0 0 78 78" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <g clip-path="url(#clip0_139_2)">
                        <rect x="35" width="8" height="78" fill="#D9D9D9" />
                        <rect x="78" y="35" width="8" height="78" transform="rotate(90 78 35)" fill="#D9D9D9" />
                      </g>
                      <defs>
                        <clipPath id="clip0_139_2">
                          <rect width="78" height="78" fill="white" />
                        </clipPath>
                      </defs>
                    </svg>
                  </a>
                </li>
  
                <!--Добавленные книги-->
                {% for item in pagination_for_book_in_list.items %}
                <li class="list__book" id="{{cataloge_value.id}}book_info">      
                  <a href="{{url_for('main.book_page', name=item.book.name)}}" class="list__book-set">
                    <img class="list__book-set" src="{{url_for('main.cover', name=item.book.name)}}" alt="">
                  </a>
                  
                  <div class="list__book-wrap">
                        <a href="{{url_for('main.book_page', name=item.book.name)}}" class="list__link-book">Книга: {{ item.book.name
                        }}</a>
                      <a href="#" class="list__link">Состояние чтения: {{ item.read_state }}</a>
  
                      <!--<select class="list__select">
                      <option value="">Планирую</option>
                      <option value="">Читаю</option>
                      <option value="">Заброшено</option>
                      <option value="">Прочитано</option>
                      </select>-->
                      <a class="list__book-delete-btn"
                        href="{{url_for('personal.item_delete', username=current_user.username, item_id=item.id, page=pagination.page)}}">Удалить
                        книгу из списка</a>
                  </div>
                </li>
                {% endfor %}
              </ul>
                {% if pagination_for_book_in_list %}
                    <div class="list__pagination pagination">
                      <ul class="pagination__list list-reset" id="{{cataloge_value.id}}books_pagination">
                        <li{% if not pagination_for_book_in_list.has_prev %} class="pagination__item disabled"{% endif %}>
                            <a onclick="{% if pagination_for_book_in_list.has_prev %}get_books_page('/user/{{current_user.username}}/get_books_page/{{cataloge_value.id}}/{{pagination_for_book_in_list.prev_num}}', '{{cataloge_value.id}}'){% endif %}" id="lists_back">
                                &laquo;
                            </a>
                            <script>scroll('lists_back')</script>
                        </li>
                        {% for p in pagination_for_book_in_list.iter_pages() %}
                            {% if p %}
                                <li class="pagination__item active">
                                    <a onclick="get_books_page('/user/{{current_user.username}}/get_books_page/{{cataloge_value.id}}/{{p}}', '{{cataloge_value.id}}')">{{ p }}</a>
                                </li>
                                <script>scroll({{ p }} + 'list_pagination')</script>
                            {% else %}
                            <li class="pagination__item disabled"><a href="#">&hellip;</a></li>
                            {% endif %}
                        {% endfor %}
                        <li{% if not pagination_for_book_in_list.has_next %} class="pagination__item disabled"{% endif %}>
                            <a onclick="{% if pagination_for_book_in_list.has_next %}get_books_page('/user/{{current_user.username}}/get_books_page/{{cataloge_value.id}}/{{pagination_for_book_in_list.next_num}}', '{{cataloge_value.id}}'){% endif %}" id="lists_up">
                                &raquo;
                            </a>
                            <script>scroll('lists_up')</script>
                        </li>
                      </ul>
                    </div>
                {% endif %}
  
              {% if pagination %}
               <a class="list__delete-btn" onclick="del_list('/user/{{current_user.username}}/delete-list/{{cataloge_value.id}}/{{1}}')" id="{{cataloge_value.id}}del_list">
                <svg width="461" height="1" viewBox="0 0 461 1" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <line y1="0.5" x2="461" y2="0.5" stroke="black" />
                </svg>
                Удалить список
                <svg width="461" height="1" viewBox="0 0 461 1" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <line y1="0.5" x2="461" y2="0.5" stroke="black" />
                </svg>
                </a>
              {% endif %}
                <script>scroll({{ cataloge_value.id }} + 'del_list')</script>
            </div>
          </div>
        </section>
        {% endfor %}
    </div>
    {% if pagination %}
      <div class="list__pagination pagination" id="pagination_container">
        <ul class="pagination__list list-reset" id="pagination">
          <li{% if not pagination.has_prev %} class="pagination__item disabled"{% endif %}>
              <a onclick="{% if pagination.has_prev %}get_lists_page('/user/{{current_user.username}}/get_lists_page/{{pagination.prev_num}}'){% endif %}" id="lists_back">
                  &laquo;
              </a>
              <script>scroll('lists_back')</script>
          </li>
          {% for p in pagination.iter_pages() %}
              {% if p %}
                  <li class="pagination__item active">
                      <a onclick="get_lists_page('/user/{{current_user.username}}/get_lists_page/{{p}}')">{{ p }}</a>
                  </li>
                  <script>scroll({{ p }} + 'list_pagination')</script>
              {% else %}
              <li class="pagination__item disabled"><a href="#">&hellip;</a></li>
              {% endif %}
          {% endfor %}
          <li{% if not pagination.has_next %} class="pagination__item disabled"{% endif %}>
              <a onclick="{% if pagination.has_next %}get_lists_page('/user/{{current_user.username}}/get_lists_page/{{pagination.next_num}}'){% endif %}" id="lists_up">
                  &raquo;
              </a>
              <script>scroll('lists_up')</script>
          </li>
        </ul>
      </div>
    {% endif %}
  </main>

  <footer class="footer">
    <div class="footer__container container">
      <a href="#" class="footer__wrap">© CLUB | Community Head Hunters</a>
    </div>
  </footer>

</body>
</html>